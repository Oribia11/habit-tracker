<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minimal Habit/Task Tracker</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* ---------- tiny resets ---------- */
        input,
        select,
        textarea,
        button {
            font-size: 16px;
        }

        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* ---------- tokens ---------- */
        :root {
            --bg: #f6f8fa;
            --card: #ffffff;
            --muted: #64748b;
            --accent: #10b981;
            --accent-2: #34d399;
            --danger: #ef4444;
            --radius: 12px;

            /* weekday colors Mon..Sun */
            --d0: #ef4444;
            /* Mon red   */
            --d1: #f97316;
            /* Tue orange*/
            --d2: #f59e0b;
            /* Wed yellow*/
            --d3: #22c55e;
            /* Thu green */
            --d4: #3b82f6;
            /* Fri blue  */
            --d5: #a78bfa;
            /* Sat purple*/
            --d6: #06b6d4;
            /* Sun cyan  */
        }

        html,
        body {
            height: 100%;
            background: linear-gradient(180deg, #f8fafc 0%, #f6f8fa 100%);
            color: #0f172a;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 14px;
        }

        /* ---------- cards / buttons ---------- */
        .card {
            background: linear-gradient(180deg, var(--card), #fbfdff);
            border: 1px solid rgba(15, 23, 42, .06);
            border-radius: var(--radius);
            box-shadow: 0 6px 18px rgba(15, 23, 42, .04);
            padding: 16px;
        }

        .card-title {
            font-weight: 700;
            font-size: 14px
        }

        .sub {
            color: var(--muted);
            font-size: 13px
        }

        .btn {
            border-radius: 10px;
            padding: 8px 12px;
            border: 1px solid rgba(2, 6, 23, .06);
            background: #fff;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer
        }

        .btn.small {
            padding: 6px 10px;
            border-radius: 8px
        }

        .btn.ghost {
            background: transparent;
            border-color: transparent;
            color: var(--muted)
        }

        .btn.primary {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: #fff;
            border: none
        }

        .pill {
            font-size: 11px;
            padding: 2px 8px;
            background: #eef2f7;
            border-radius: 999px;
            border: 1px solid #e5edf5
        }

        .list-fit {
            overflow: auto;
            max-height: calc(100vh - 220px);
        }

        /* Main grid override: make the responsibilities column narrower and the middle column flexible */
        #mainGrid {
            display: grid;
            grid-template-columns: 1fr 1fr 360px;
            gap: 12px;
        }

        /* Responsibilities list sizing inside its card */
        #respList {
            max-height: calc(100vh - 420px);
            overflow: auto;
            padding-right: 6px;
            /* room for scrollbar */
        }

        /* Slight visual refinement for card titles */
        .card-title {
            margin-bottom: 6px;
            display: block;
        }

        /* Make popovers responsive on narrow screens */
        @media (max-width: 900px) {
            #mainGrid {
                grid-template-columns: 1fr;
            }

            .resp-item {
                padding-right: 12px;
            }

            .resp-actions {
                right: 8px;
                top: 8px;
            }

            .popover {
                left: 12px;
                right: 12px;
                width: auto;
                box-sizing: border-box;
            }

            .card {
                padding: 12px;
            }
        }

        /* ---------- responsibilities UI ---------- */
        .resp-item {
            position: relative;
            border: 1px solid rgba(15, 23, 42, .05);
            border-radius: 10px;
            padding: 12px;
            /* leave space for action icons to the right so they don't overlap the title */
            padding-right: 56px;
            background: #fff
        }

        .resp-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px
        }

        .resp-name {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .resp-meta {
            font-size: 12px;
            color: var(--muted);
            margin-left: 8px;
            white-space: nowrap;
            font-weight: 600;
        }

        .resp-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            gap: 6px;
            opacity: .0;
            transform: translateY(-2px);
            transition: opacity .12s ease, transform .12s ease;
        }

        .resp-item:hover .resp-actions,
        .resp-item:focus-within .resp-actions {
            opacity: 1;
            transform: translateY(0)
        }

        .icon-btn {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: inline-grid;
            place-items: center;
            background: #fff;
            border: 1px solid rgba(15, 23, 42, .08);
            color: #334155;
            cursor: pointer
        }

        .icon-btn:hover {
            background: #f8fafc
        }

        /* percent line */
        .resp-line {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            margin-top: 8px
        }

        .bar {
            height: 12px;
            border-radius: 8px;
            overflow: hidden;
            background: #e9eef5;
            position: relative
        }

        .seg {
            height: 100%;
            float: left;
            /* interactive: pointer + subtle hover */
            cursor: pointer;
        }

        .seg:hover {
            filter: brightness(.96);
        }

        /* widths set inline style */

        .d0 {
            background: var(--d0)
        }

        .d1 {
            background: var(--d1)
        }

        .d2 {
            background: var(--d2)
        }

        .d3 {
            background: var(--d3)
        }

        .d4 {
            background: var(--d4)
        }

        .d5 {
            background: var(--d5)
        }

        .d6 {
            background: var(--d6)
        }

        .pct {
            font-size: 12px;
            color: var(--muted);
            min-width: 36px;
            text-align: right
        }

        /* add-hours popover */
        .popover {
            position: absolute;
            right: 10px;
            top: 44px;
            background: #fff;
            border: 1px solid #e6eef2;
            border-radius: 10px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, .08);
            padding: 10px;
            width: 230px;
            z-index: 10
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .row+.row {
            margin-top: 8px
        }

        .popover input,
        .popover select {
            border: 1px solid #e6eef2;
            background: #fbfdff;
            padding: 8px;
            border-radius: 8px;
            font-size: 13px
        }

        .popover .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end
        }

        /* Top small nav animations (subtle) */
        .pulse {
            animation: pulse .25s ease-out
        }

        @keyframes pulse {
            from {
                transform: scale(.98)
            }

            to {
                transform: scale(1)
            }
        }

        /* small slide animations for date navigation feedback */
        @keyframes slide-left {
            0% {
                transform: translateX(8px);
                opacity: 0;
            }

            60% {
                transform: translateX(-4px);
                opacity: 1;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slide-right {
            0% {
                transform: translateX(-8px);
                opacity: 0;
            }

            60% {
                transform: translateX(4px);
                opacity: 1;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .nav-anim-left {
            animation: slide-left .36s cubic-bezier(.2, .9, .2, 1);
        }

        .nav-anim-right {
            animation: slide-right .36s cubic-bezier(.2, .9, .2, 1);
        }

        /* section header helper to avoid wrapping/stacking problems in narrow layouts */
        .section-head {
            flex-wrap: wrap;
            align-items: center;
        }

        .section-head .pill {
            white-space: nowrap;
            /* keep pill on one line */
            margin-left: 6px;
        }

        .section-head .btn {
            flex-shrink: 0;
            /* keep buttons from collapsing */
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
            <div>
                <div id="dateHeading" class="card-title"></div>
                <div id="weekMeta" class="sub" style="margin-top:4px"></div>
                <div id="eventBanner" class="sub" style="margin-top:4px"></div>
            </div>
            <div style="display:flex; gap:8px">
                <button id="passBtn" class="btn small ghost">Passcode</button>
                <button id="exportBtn" class="btn small ghost">Export</button>
                <label class="btn small ghost" style="cursor:pointer">Import
                    <input id="importInput" type="file" accept="application/json" class="hidden" />
                </label>
            </div>
        </div>

        <!-- Top stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="card">
                <div style="display:flex; align-items:center; justify-content:space-between">
                    <div>
                        <div class="card-title">This week</div>
                        <div id="weekBarLabel" class="sub" style="margin-top:6px">0 / 0 tasks completed this week (0%)
                        </div>
                    </div>
                    <div id="weekPct" class="card-title">0%</div>
                </div>
                <div class="mt-2 h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div id="weekBar" class="h-full"
                        style="width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2))"></div>
                </div>
            </div>
            <div class="card">
                <div style="display:flex; align-items:center; justify-content:space-between">
                    <div class="card-title">Weekly completion trend</div>
                    <div class="sub">Since Q1 start</div>
                </div>
                <div id="trendWrap" class="mt-1 h-28 md:h-32"><canvas id="trendChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Main: Daily | Weekly | Responsibilities -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <!-- Daily -->
            <section class="card flex flex-col">
                <div class="flex items-center justify-between gap-2 section-head">
                    <div class="flex items-center gap-2 text-sm">
                        <button id="prevDay" class="btn small ghost">◀</button>
                        <button id="todayBtn" class="btn small ghost">Today</button>
                        <button id="nextDay" class="btn small ghost">▶</button>
                        <span id="dailyDateLabel" class="ml-2 text-slate-600"></span>
                    </div>
                    <button id="addDaily" class="btn small primary">+ Daily</button>
                </div>
                <div id="dailyList" class="mt-2 space-y-1 list-fit"></div>
                <div class="mt-3">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold">Notes for this day</h4>
                        <span id="dailyNotesSaved" class="text-[11px] text-slate-500"></span>
                    </div>
                    <textarea id="dailyNotes"
                        class="mt-1 w-full min-h-[64px] rounded-md border border-slate-300 p-2 text-sm"
                        placeholder="Quick notes for this day (reflections, blockers)"></textarea>
                </div>
            </section>

            <!-- Weekly -->
            <section class="card flex flex-col">
                <div class="flex items-center justify-between gap-2 section-head">
                    <div class="flex items-center gap-2 text-sm">
                        <button id="prevWeek" class="btn small ghost">◀</button>
                        <button id="thisWeekBtn" class="btn small ghost">This week</button>
                        <button id="nextWeek" class="btn small ghost">▶</button>
                        <span id="weeklyRangeLabel" class="ml-2 text-slate-600"></span>
                        <span id="weeklyMetaPill" class="pill ml-2"></span>
                    </div>
                    <button id="addWeekly" class="btn small primary">+ Weekly</button>
                </div>
                <div id="weeklyList" class="mt-2 space-y-1 list-fit"></div>
                <div class="mt-2">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold">Notes for this week</h4>
                        <span id="notesSaved" class="text-[11px] text-slate-500"></span>
                    </div>
                    <textarea id="weekNotes"
                        class="mt-1 w-full min-h-[56px] rounded-md border border-slate-300 p-2 text-sm"
                        placeholder="Reflections, wins, blockers…"></textarea>
                </div>
            </section>

            <!-- Responsibilities -->
            <section class="card flex flex-col">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Responsibilities (hours)</h3>
                    <button id="addRespBtn" class="btn small primary">+ Add responsibility</button>
                </div>

                <!-- Weekly totals -->
                <div id="respSummary" class="mt-3 flex items-center justify-between">
                    <div id="respTotals" class="sub">0h logged / 0h expected</div>
                    <div style="flex:0 0 48%; max-width:48%">
                        <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                            <div id="respTotalBar" class="h-full"
                                style="width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2))"></div>
                        </div>
                    </div>
                </div>

                <div id="respList" class="mt-2 space-y-2 list-fit"></div>
                <p class="mt-2 text-[11px] text-slate-500">
                    Click <b>+</b> on a card to log hours. You can type <code>1h</code>, <code>30m</code>,
                    <code>1:30</code>, or <code>2</code>.
                </p>
            </section>
        </div>

        <p class="mt-2 text-[11px] text-slate-500">Local-only, privacy-friendly. Data stays in your browser.</p>
    </div>

    <script>
        /* ================================================================
           Academic calendar + date helpers
        ================================================================ */
        const ACADEMIC = {
            q1: { id: 'Q1', start: '2025-09-01', end: '2025-11-08' },
            q2: { id: 'Q2', start: '2025-11-10', end: '2026-01-31' },
            q3: { id: 'Q3', start: '2026-02-02', end: '2026-04-18' },
            q4: { id: 'Q4', start: '2026-04-20', end: '2026-07-04' },
            important: [
                { date: '2025-09-26', label: 'Momentum (no teaching)' },
                { date: '2025-10-12', label: 'Closing date: registration/withdrawal exams & courses Q1' },
                { date: '2025-11-15', label: 'Opens: registration Q3 & Q4' },
                { start: '2025-12-22', end: '2026-01-02', label: 'Christmas recess (no teaching)' },
                { date: '2026-01-04', label: 'Closing date: registration/withdrawal exams & courses Q2' },
                { start: '2026-02-16', end: '2026-02-20', label: 'Carnival holiday' },
                { date: '2026-03-14', label: "Master's open day (no teaching from 17:30)" },
                { date: '2026-03-22', label: 'MyFuture week + Closing date registration/withdrawal Q3' },
                { date: '2026-04-03', label: 'Good Friday' },
                { date: '2026-04-05', label: 'Easter Sunday' },
                { date: '2026-04-06', label: 'Easter Monday' },
                { date: '2026-04-27', label: "King's Day" },
                { date: '2026-05-04', label: 'Bridge Day' },
                { date: '2026-05-05', label: 'Liberation Day' },
                { start: '2026-05-14', end: '2026-05-15', label: 'Ascension Day + Bridge Day' },
                { date: '2026-05-24', label: 'Whitsun' },
                { date: '2026-05-25', label: 'Whit Monday' },
                { date: '2026-06-07', label: 'Closing date registration/withdrawal exams & courses Q4' },
                { date: '2026-06-15', label: 'Opening registration for Q1 & Q2 (next year)' },
            ]
        };
        const MONTH_ABBR = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
        const WEEKDAY = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        function dFromISO(iso) { const [y, m, d] = iso.split('-').map(Number); const dt = new Date(y, m - 1, d, 12); dt.setHours(12); return dt; }
        function toISODate(dt) { const y = dt.getFullYear(); const m = String(dt.getMonth() + 1).padStart(2, '0'); const d = String(dt.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
        function startOfWeek(dt) { const d = new Date(dt); const day = d.getDay(); const diff = (day === 0 ? -6 : 1 - day); d.setDate(d.getDate() + diff); d.setHours(12); return d; }
        function addDays(dt, n) { const d = new Date(dt); d.setDate(d.getDate() + n); d.setHours(12); return d; }
        function addWeeks(dt, n) { return addDays(dt, n * 7); }
        function formatHeadingDate(dt) { return `${WEEKDAY[dt.getDay()]} ${String(dt.getDate()).padStart(2, '0')}${MONTH_ABBR[dt.getMonth()]}${dt.getFullYear()}`; }
        const Q_LIST = [ACADEMIC.q1, ACADEMIC.q2, ACADEMIC.q3, ACADEMIC.q4]; const Q1_START = dFromISO(ACADEMIC.q1.start);
        function findQuartile(dt) { const iso = toISODate(dt); for (const q of Q_LIST) { if (iso >= q.start && iso <= q.end) return q; } return null; }
        function weekNumberInQuartile(dt) { const q = findQuartile(dt); if (!q) return { q: null, weekInQ: null }; const start = startOfWeek(dFromISO(q.start)); const monday = startOfWeek(dt); const diffDays = Math.floor((monday - start) / 86400000); return { q, weekInQ: Math.floor(diffDays / 7) + 1 }; }
        function overallWeekNumber(dt) { const start = startOfWeek(Q1_START); const monday = startOfWeek(dt); const diffDays = Math.floor((monday - start) / 86400000); return Math.floor(diffDays / 7) + 1; }
        function formatWeekRange(dt) { const mon = startOfWeek(dt); const sun = addDays(mon, 6); const m1 = MONTH_ABBR[mon.getMonth()], m2 = MONTH_ABBR[sun.getMonth()]; return `${String(mon.getDate()).padStart(2, '0')}${m1}${mon.getFullYear()} – ${String(sun.getDate()).padStart(2, '0')}${m2}${sun.getFullYear()}`; }
        function todayEventBanner(dt) { const iso = toISODate(dt); for (const e of ACADEMIC.important) { if (e.date && e.date === iso) return e.label; if (e.start && e.end && iso >= e.start && iso <= e.end) return e.label; } return ''; }

        /* ================================================================
           Storage (with optional passcode encryption)
        ================================================================ */
        const LS_KEY = 'habitTrackerV1';
        const LS_ENC = 'habitTrackerV1_enc';
        const LS_META = 'habitTrackerV1_meta';
        const initialState = {
            habits: [],
            completions: { daily: {}, weekly: {} },
            notes: { weekly: {}, daily: {} },
            responsibilities: {},         // {id:{id,title,expectedHours}}
            respEntries: {}               // {id:{'YYYY-MM-DD': hours}}
        };
        function loadPlain() { try { return JSON.parse(localStorage.getItem(LS_KEY)) || structuredClone(initialState); } catch (e) { return structuredClone(initialState); } }
        const b2a = (bytes) => btoa(String.fromCharCode(...bytes));
        const a2b = (b64) => new Uint8Array(atob(b64).split('').map(c => c.charCodeAt(0)));
        async function deriveAesKey(pass, saltB64, iterations) { const enc = new TextEncoder(); const base = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']); return await crypto.subtle.deriveKey({ name: 'PBKDF2', salt: a2b(saltB64), iterations, hash: 'SHA-256' }, base, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']); }
        async function encryptJSON(obj, key) { const iv = crypto.getRandomValues(new Uint8Array(12)); const data = new TextEncoder().encode(JSON.stringify(obj)); const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data); return { iv: b2a(iv), ct: b2a(new Uint8Array(ct)) }; }
        async function decryptJSON(bundle, key) { const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: a2b(bundle.iv) }, key, a2b(bundle.ct)); return JSON.parse(new TextDecoder().decode(new Uint8Array(pt))); }

        let state = structuredClone(initialState), passEnabled = false, passKey = null, meta = null;
        async function save() {
            state.notes = state.notes || { weekly: {}, daily: {} };
            if (passEnabled && passKey) {
                const bundle = await encryptJSON(state, passKey);
                localStorage.setItem(LS_ENC, JSON.stringify(bundle));
                localStorage.setItem(LS_META, JSON.stringify(meta));
                localStorage.removeItem(LS_KEY);
            } else {
                localStorage.setItem(LS_KEY, JSON.stringify(state));
            }
        }

        /* ================================================================
           UI helpers & CRUD
        ================================================================ */
        function uid() { return Math.random().toString(36).slice(2, 10); }
        function el(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstElementChild; }

        function addHabit(type) {
            const title = prompt(`New ${type} habit name:`)?.trim(); if (!title) return;
            state.habits.push({ id: uid(), title, type, createdAt: Date.now(), order: Date.now() }); save(); renderAll();
        }
        function editHabit(id) {
            const h = state.habits.find(h => h.id === id); if (!h) return;
            const next = prompt('Rename habit:', h.title)?.trim(); if (!next) return;
            h.title = next; save(); renderAll();
        }
        function deleteHabit(id) {
            const h = state.habits.find(h => h.id === id); if (!h) return;
            if (!confirm(`Delete “${h.title}”?`)) return;
            state.habits = state.habits.filter(x => x.id !== id);
            for (const d in state.completions.daily) { if (state.completions.daily[d]) delete state.completions.daily[d][id]; }
            for (const w in state.completions.weekly) { if (state.completions.weekly[w]) delete state.completions.weekly[w][id]; }
            save(); renderAll();
        }

        /* ---------------- responsibilities ---------------- */
        function addResponsibility() {
            const title = prompt('Responsibility name (e.g., POLAR):')?.trim(); if (!title) return;
            const exp = parseFloat(prompt('Expected hours per week:', '2') || '0') || 0;
            const id = uid(); (state.responsibilities ||= {})[id] = { id, title, expectedHours: exp }; (state.respEntries ||= {})[id] = {};
            save(); renderAll();
        }
        function renameResponsibility(id) {
            const r = state.responsibilities[id]; if (!r) return;
            const n = prompt('Rename:', r.title)?.trim(); if (!n) return; r.title = n; save(); renderAll();
        }
        function deleteResponsibility(id) {
            const r = state.responsibilities[id]; if (!r) return;
            if (!confirm(`Delete “${r.title}”?`)) return;
            delete state.responsibilities[id]; delete state.respEntries[id]; save(); renderAll();
        }

        /* ================================================================
           Toggles
        ================================================================ */
        function isPastDay(viewDate) { const t = dFromISO(toISODate(new Date())); return toISODate(viewDate) < toISODate(t); }
        function isPastWeek(viewDate) { const t = startOfWeek(new Date()); return weekKey(viewDate) < weekKey(t); }
        function toggleDaily(habitId, dateIso, value) { state.completions.daily[dateIso] ||= {}; state.completions.daily[dateIso][habitId] = !!value; save(); updateProgressBits(); }
        function toggleWeekly(habitId, wkKey, value) { state.completions.weekly[wkKey] ||= {}; state.completions.weekly[wkKey][habitId] = !!value; save(); updateProgressBits(); }

        /* ================================================================
           Rendering: header, daily, weekly
        ================================================================ */
        const dateHeading = document.getElementById('dateHeading');
        const weekMeta = document.getElementById('weekMeta');
        const eventBanner = document.getElementById('eventBanner');
        const dailyList = document.getElementById('dailyList');
        const weeklyList = document.getElementById('weeklyList');
        const prevDay = document.getElementById('prevDay');
        const nextDay = document.getElementById('nextDay');
        const todayBtn = document.getElementById('todayBtn');
        const dailyDateLabel = document.getElementById('dailyDateLabel');
        const prevWeek = document.getElementById('prevWeek');
        const nextWeek = document.getElementById('nextWeek');
        const thisWeekBtn = document.getElementById('thisWeekBtn');
        const weeklyRangeLabel = document.getElementById('weeklyRangeLabel');
        const weeklyMetaPill = document.getElementById('weeklyMetaPill');
        const addDailyBtn = document.getElementById('addDaily');
        const addWeeklyBtn = document.getElementById('addWeekly');
        const weekBar = document.getElementById('weekBar');
        const weekBarLabel = document.getElementById('weekBarLabel');
        const weekPct = document.getElementById('weekPct');
        const passBtn = document.getElementById('passBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importInput = document.getElementById('importInput');
        const weekNotesEl = document.getElementById('weekNotes');
        const notesSaved = document.getElementById('notesSaved');
        const dailyNotesEl = document.getElementById('dailyNotes');
        const dailyNotesSaved = document.getElementById('dailyNotesSaved');
        const addRespBtn = document.getElementById('addRespBtn');
        const respList = document.getElementById('respList');
        const respTotalsEl = document.getElementById('respTotals');
        const respTotalBar = document.getElementById('respTotalBar');

        let viewDay = dFromISO(toISODate(new Date()));
        let viewWeekDay = dFromISO(toISODate(new Date()));
        let chart, notesDebounce;

        function weekKey(dt) {
            const monday = startOfWeek(dt); const y = monday.getFullYear(); const oneJan = new Date(y, 0, 1, 12);
            const days = Math.floor((monday - startOfWeek(oneJan)) / 86400000);
            const wk = Math.floor(days / 7) + 1;
            return `${y}-W${String(wk).padStart(2, '0')}`;
        }

        function renderHeader() {
            const dt = dFromISO(toISODate(new Date()));
            const { q, weekInQ } = weekNumberInQuartile(dt);
            const overall = Math.max(1, overallWeekNumber(dt));
            dateHeading.textContent = formatHeadingDate(dt);
            weekMeta.textContent = `Week #${overall}; week #${weekInQ ?? '—'}; ${q ? q.id : 'N/A'}`;
            eventBanner.textContent = todayEventBanner(dt) || '';
        }

        function renderDaily() {
            dailyDateLabel.textContent = formatHeadingDate(viewDay);
            const readOnly = isPastDay(viewDay); const iso = toISODate(viewDay);
            const habits = state.habits.filter(h => h.type === 'daily').sort((a, b) => a.order - b.order);
            const done = state.completions.daily[iso] || {};
            dailyList.innerHTML = '';
            if (habits.length === 0) dailyList.appendChild(el(`<div class="sub">No daily habits yet.</div>`));
            for (const h of habits) {
                const row = el(`
      <div class="group flex items-center justify-between border border-slate-200 rounded-xl px-3 py-2 bg-white">
        <label class="flex items-center gap-3 text-sm">
          <input type="checkbox" class="h-5 w-5 rounded border-slate-300" ${done[h.id] ? 'checked' : ''} ${readOnly ? 'disabled' : ''}>
          <span>${h.title}</span>
        </label>
        <div class="invisible group-hover:visible flex items-center gap-1">
          <button class="btn small" data-edit>Edit</button>
          <button class="btn small" style="color:var(--danger);border-color:#ffd1d1;background:#fff5f5" data-del>Delete</button>
        </div>
      </div>`);
                row.querySelector('input').addEventListener('change', e => toggleDaily(h.id, iso, e.target.checked));
                row.querySelector('[data-edit]').addEventListener('click', () => editHabit(h.id));
                row.querySelector('[data-del]').addEventListener('click', () => deleteHabit(h.id));
                dailyList.appendChild(row);
            }
            // notes (per-ISO)
            dailyNotesEl.value = state.notes?.daily?.[iso] || '';
            dailyNotesSaved.textContent = '';
            let t; dailyNotesEl.oninput = (e) => {
                clearTimeout(t); state.notes.daily[iso] = e.target.value; dailyNotesSaved.textContent = 'Saving…';
                t = setTimeout(async () => { await save(); dailyNotesSaved.textContent = 'Saved'; setTimeout(() => { if (dailyNotesSaved.textContent === 'Saved') dailyNotesSaved.textContent = ''; }, 1000); }, 300);
            };
        }

        function renderWeekly() {
            weeklyRangeLabel.textContent = formatWeekRange(viewWeekDay);
            const readOnly = isPastWeek(viewWeekDay); const wk = weekKey(viewWeekDay);
            const habits = state.habits.filter(h => h.type === 'weekly').sort((a, b) => a.order - b.order);
            const done = state.completions.weekly[wk] || {};
            weeklyList.innerHTML = '';
            if (habits.length === 0) weeklyList.appendChild(el(`<div class="sub">No weekly habits yet.</div>`));
            for (const h of habits) {
                const row = el(`
      <div class="group flex items-center justify-between border border-slate-200 rounded-xl px-3 py-2 bg-white">
        <label class="flex items-center gap-3 text-sm">
          <input type="checkbox" class="h-5 w-5 rounded border-slate-300" ${done[h.id] ? 'checked' : ''} ${readOnly ? 'disabled' : ''}>
          <span>${h.title}</span>
        </label>
        <div class="invisible group-hover:visible flex items-center gap-1">
          <button class="btn small" data-edit>Edit</button>
          <button class="btn small" style="color:var(--danger);border-color:#ffd1d1;background:#fff5f5" data-del>Delete</button>
        </div>
      </div>`);
                row.querySelector('input').addEventListener('change', e => toggleWeekly(h.id, wk, e.target.checked));
                row.querySelector('[data-edit]').addEventListener('click', () => editHabit(h.id));
                row.querySelector('[data-del]').addEventListener('click', () => deleteHabit(h.id));
                weeklyList.appendChild(row);
            }

            // notes + pill
            weekNotesEl.value = state.notes?.weekly?.[wk] || '';
            notesSaved.textContent = '';
            weekNotesEl.oninput = (e) => {
                clearTimeout(notesDebounce); state.notes.weekly[wk] = e.target.value; notesSaved.textContent = 'Saving…';
                notesDebounce = setTimeout(async () => { await save(); notesSaved.textContent = 'Saved'; setTimeout(() => { if (notesSaved.textContent === 'Saved') notesSaved.textContent = ''; }, 1000); }, 300);
            };
            const { q, weekInQ } = weekNumberInQuartile(viewWeekDay) || {}; const overall = overallWeekNumber(viewWeekDay);
            weeklyMetaPill.textContent = `W${overall}${q ? ` • ${q.id} w${weekInQ}` : ''}`;
        }

        /* ================================================================
           Responsibilities
           - stacked weekday bar 0→100%
           - visible icon buttons (Add, Rename, Delete)
           - Add shows popover with day picker (default = today) + hours input
        ================================================================ */
        const DAY_COLORS = ['d0', 'd1', 'd2', 'd3', 'd4', 'd5', 'd6']; // classes
        function parseHours(str) {
            if (!str) return null;
            const s = str.trim().toLowerCase();
            // "1:30" or "1.30"
            let m = s.match(/^(\d+)\s*[:.]\s*(\d{1,2})$/); if (m) return +(parseInt(m[1]) + (parseInt(m[2]) || 0) / 60).toFixed(2);
            // "1h 20m", "90m"
            let h = 0, hit = false;
            m = s.match(/(\d+(?:\.\d+)?)\s*h/); if (m) { h += parseFloat(m[1]); hit = true; }
            m = s.match(/(\d+(?:\.\d+)?)\s*m/); if (m) { h += parseFloat(m[1]) / 60; hit = true; }
            if (!hit) { // plain number => hours
                const v = parseFloat(s); if (!isNaN(v)) h += v; else return null;
            }
            return +h.toFixed(2);
        }

        function formatHours(h) {
            const v = Math.round((Number(h) || 0) * 100) / 100;
            if (Number.isInteger(v)) return String(v) + 'h';
            return String(v).replace(/\.0+$/, '') + 'h';
        }

        function renderResponsibilities() {
            respList.innerHTML = '';
            const keys = Object.keys(state.responsibilities || {});
            const mon = startOfWeek(viewWeekDay);

            // totals
            let logged = 0, expected = 0;
            for (const id of keys) {
                expected += +((state.responsibilities[id]?.expectedHours) || 0);
                const ent = state.respEntries[id] || {};
                for (let i = 0; i < 7; i++) { const iso = toISODate(addDays(mon, i)); logged += +(ent[iso] || 0); }
            }
            respTotalsEl.textContent = `${logged}h logged / ${expected}h expected`;
            respTotalBar.style.width = expected > 0 ? Math.min(100, Math.round((logged / expected) * 100)) + '%' : '0%';

            if (keys.length === 0) {
                respList.appendChild(el(`<div class="sub">No responsibilities yet.</div>`));
                return;
            }

            // sort by title
            keys.sort((a, b) => (state.responsibilities[a].title || '').localeCompare(state.responsibilities[b].title || ''));

            for (const id of keys) {
                const r = state.responsibilities[id];
                const entries = state.respEntries[id] || {};
                let total = 0; const dayVals = [];
                for (let i = 0; i < 7; i++) { const iso = toISODate(addDays(mon, i)); const v = +(entries[iso] || 0); total += v; dayVals.push(v); }
                const pct = r.expectedHours > 0 ? Math.min(100, Math.round((total / r.expectedHours) * 100)) : 0;

                const row = el(`
            <div class="resp-item">
                <div class="resp-head">
                    <div style="display:flex; align-items:center; gap:8px">
                        <div class="resp-name">${r.title}</div>
                        <div class="resp-meta" data-meta></div>
                    </div>
                    <div class="resp-actions">
            <button class="icon-btn" title="Add hours" data-add-hrs>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
            </button>
            <button class="icon-btn" title="Rename" data-rename>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h3.75L17.81 9.94l-3.75-3.75L3 17.25V21z"/></svg>
            </button>
            <button class="icon-btn" title="Delete" data-del>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
            </button>
          </div>
        </div>

        <div class="resp-line">
          <div class="bar"></div>
          <div class="pct">${pct}%</div>
        </div>
      </div>
    `);

                // draw stacked segments relative to expected hours (cap at 100%)
                const bar = row.querySelector('.bar');
                const expected = r.expectedHours || 0;
                let remaining = 100; // remaining width
                if (expected > 0) {
                    const scale = 100 / expected;
                    for (let i = 0; i < 7; i++) {
                        const rawW = dayVals[i] * scale;          // what width this day would take
                        const w = Math.max(0, Math.min(remaining, rawW));
                        if (w <= 0) continue;
                        remaining -= w;
                        const seg = el(`<div class="seg ${DAY_COLORS[i]}" style="width:${w}%" title="${WEEKDAY[(i + 1) % 7]}: ${dayVals[i]}h"></div>`);
                        // clicking a segment opens the add popover prefilled for that weekday
                        seg.addEventListener('click', (ev) => openAddPopover(ev.currentTarget, id, i, null));
                        bar.appendChild(seg);
                        if (remaining <= 0) break;
                    }
                }
                // if no expected, leave empty bar; percent stays 0.

                // action handlers
                row.querySelector('[data-rename]').addEventListener('click', () => renameResponsibility(id));
                row.querySelector('[data-del]').addEventListener('click', () => deleteResponsibility(id));
                row.querySelector('[data-add-hrs]').addEventListener('click', (ev) => openAddPopover(ev.currentTarget, id));

                respList.appendChild(row);
                // fill in the meta (completed/expected)
                const metaEl = row.querySelector('[data-meta]');
                if (metaEl) metaEl.textContent = `${formatHours(total)} / ${formatHours(expected)}`;
            }
        }

        function openAddPopover(anchorBtn, id, preDay = null, preHours = null) {
            closeAnyPopover();

            const container = anchorBtn.closest('.resp-item');
            const pop = el(`
    <div class="popover">
      <div class="row">
        <label class="sub" style="min-width:68px">Day</label>
        <select id="pop-day" class="flex-1">
          <option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option>
          <option value="3">Thu</option><option value="4">Fri</option><option value="5">Sat</option><option value="6">Sun</option>
        </select>
      </div>
      <div class="row">
        <label class="sub" style="min-width:68px">Hours</label>
        <input id="pop-hours" placeholder="e.g. 1h, 30m, 1:30" class="flex-1"/>
      </div>
      <div class="row actions">
        <button class="btn small" data-cancel>Cancel</button>
        <button class="btn small primary" data-save>Save</button>
      </div>
    </div>
  `);
            container.appendChild(pop);

            // default selection = today's weekday index mapped to Mon=0..Sun=6
            const today = new Date();
            let dow = today.getDay(); // Sun=0..Sat=6
            dow = (dow === 0 ? 6 : dow - 1);
            pop.querySelector('#pop-day').value = preDay !== null ? String(preDay) : String(dow);
            if (preHours !== null) pop.querySelector('#pop-hours').value = preHours;
            pop.querySelector('#pop-hours').focus();

            function done() { pop.remove(); document.removeEventListener('click', outside); }
            function outside(e) { if (!pop.contains(e.target) && e.target !== anchorBtn) done(); }
            document.addEventListener('click', outside, { capture: true });

            pop.querySelector('[data-cancel]').addEventListener('click', done);
            pop.querySelector('[data-save]').addEventListener('click', async () => {
                const dayIndex = parseInt(pop.querySelector('#pop-day').value, 10);
                const amount = parseHours(pop.querySelector('#pop-hours').value);
                if (amount === null) { alert('Enter hours like 1h, 30m, 1:30, or 2'); return; }
                const mon = startOfWeek(viewWeekDay);
                const iso = toISODate(addDays(mon, dayIndex));
                state.respEntries[id] = state.respEntries[id] || {};
                const prev = parseFloat(state.respEntries[id][iso]) || 0;
                state.respEntries[id][iso] = +(prev + amount).toFixed(2); // accumulate
                await save(); renderResponsibilities(); done();
            });
        }

        function closeAnyPopover() { document.querySelectorAll('.popover').forEach(p => p.remove()); }

        /* ================================================================
           Progress + trend
        ================================================================ */
        function computeWeekProgress(monday) {
            const allDaily = state.habits.filter(h => h.type === 'daily');
            const allWeekly = state.habits.filter(h => h.type === 'weekly');
            const required = allDaily.length * 7 + allWeekly.length;
            if (required === 0) return { pct: 0, num: 0, den: 0 };
            let num = 0;
            for (let i = 0; i < 7; i++) {
                const iso = toISODate(addDays(monday, i));
                const set = state.completions.daily[iso] || {};
                for (const h of allDaily) { if (set[h.id]) num++; }
            }
            const wk = weekKey(monday);
            const setW = state.completions.weekly[wk] || {};
            for (const h of allWeekly) { if (setW[h.id]) num++; }
            return { pct: Math.round((num / required) * 100), num, den: required };
        }

        function updateProgressBits() {
            const monday = startOfWeek(new Date());
            const { pct, num, den } = computeWeekProgress(monday);
            weekBar.style.width = pct + '%';
            weekBarLabel.textContent = `${num} / ${den} tasks completed this week (${pct}%)`;
            weekPct.textContent = pct + '%';
            drawTrend();
        }

        function drawTrend() {
            const ctx = document.getElementById('trendChart');
            const startMon = startOfWeek(Q1_START);
            const todayMon = startOfWeek(new Date());
            const currentWeek = Math.max(1, overallWeekNumber(todayMon));
            const windowSize = Math.min(8, currentWeek);
            const labels = [], data = [];
            for (let i = currentWeek - windowSize + 1; i <= currentWeek; i++) {
                const wkMon = addWeeks(startMon, i - 1); const { pct } = computeWeekProgress(wkMon);
                labels.push('W' + i); data.push(pct);
            }
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Completion %', data, tension: .35, pointRadius: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 100, ticks: { stepSize: 25 } }, x: { ticks: { maxRotation: 0, autoSkip: false } } },
                    plugins: { legend: { display: false }, tooltip: { intersect: false } },
                    elements: { line: { borderWidth: 2 }, point: { hitRadius: 6 } }
                }
            });
        }

        /* ================================================================
           Wiring
        ================================================================ */
        function animatePulse(el) { el.classList.add('pulse'); setTimeout(() => el.classList.remove('pulse'), 260); }
        function animateScroll(el, dir) {
            if (!el) return;
            const cls = dir === 'left' ? 'nav-anim-left' : 'nav-anim-right';
            el.classList.remove('nav-anim-left', 'nav-anim-right');
            // force reflow
            void el.offsetWidth;
            el.classList.add(cls);
            setTimeout(() => el.classList.remove(cls), 420);
        }

        prevDay.addEventListener('click', () => { viewDay = addDays(viewDay, -1); renderDaily(); animateScroll(dailyDateLabel, 'right'); });
        nextDay.addEventListener('click', () => { viewDay = addDays(viewDay, 1); renderDaily(); animateScroll(dailyDateLabel, 'left'); });
        todayBtn.addEventListener('click', () => { viewDay = dFromISO(toISODate(new Date())); renderDaily(); animateScroll(dailyDateLabel, 'left'); });

        prevWeek.addEventListener('click', () => { viewWeekDay = addWeeks(viewWeekDay, -1); renderWeekly(); animateScroll(weeklyRangeLabel, 'right'); });
        nextWeek.addEventListener('click', () => { viewWeekDay = addWeeks(viewWeekDay, 1); renderWeekly(); animateScroll(weeklyRangeLabel, 'left'); });
        thisWeekBtn.addEventListener('click', () => { viewWeekDay = dFromISO(toISODate(new Date())); renderWeekly(); animateScroll(weeklyRangeLabel, 'left'); });

        addDailyBtn.addEventListener('click', () => addHabit('daily'));
        addWeeklyBtn.addEventListener('click', () => addHabit('weekly'));
        addRespBtn.addEventListener('click', () => addResponsibility());

        /* ---- passcode actions (kept minimal; same behaviour you had) ---- */
        async function setPasscode() {
            if (passEnabled) { alert('Passcode already set.'); return; }
            const p1 = prompt('Set a passcode:'); if (!p1) return;
            const p2 = prompt('Repeat passcode:'); if (p1 !== p2) { alert('Passcodes do not match.'); return; }
            const salt = crypto.getRandomValues(new Uint8Array(16));
            meta = { salt: b2a(salt), iterations: 150000 };
            passKey = await deriveAesKey(p1, meta.salt, meta.iterations);
            passEnabled = true; await save(); alert('Passcode set. Your data is encrypted locally.');
        }
        async function lockNow() { if (!passEnabled) { const ok = confirm('No passcode set. Set one now?'); if (ok) await setPasscode(); return; } await save(); location.reload(); }
        async function changePasscode() {
            if (!passEnabled) { alert('No passcode set.'); return; }
            const cur = prompt('Enter current passcode:'); if (cur === null) return;
            try { const test = await deriveAesKey(cur, meta.salt, meta.iterations); const enc = localStorage.getItem(LS_ENC); if (enc) { await decryptJSON(JSON.parse(enc), test); } }
            catch (e) { alert('Incorrect current passcode.'); return; }
            const p1 = prompt('New passcode:'); if (!p1) return;
            const p2 = prompt('Repeat new passcode:'); if (p1 !== p2) { alert('Passcodes do not match.'); return; }
            const salt = crypto.getRandomValues(new Uint8Array(16)); meta = { salt: b2a(salt), iterations: 150000 };
            passKey = await deriveAesKey(p1, meta.salt, meta.iterations); await save(); alert('Passcode changed.');
        }
        async function removePasscode() {
            if (!passEnabled) { alert('No passcode set.'); return; }
            if (!confirm('Remove passcode and store data in plaintext on this device?')) return;
            passEnabled = false; passKey = null; meta = null; localStorage.removeItem(LS_META); localStorage.removeItem(LS_ENC); await save(); alert('Passcode removed.');
        }
        function updatePassBtn() { passBtn.textContent = passEnabled ? 'Passcode (On)' : 'Passcode (Off)'; }
        passBtn.addEventListener('click', async () => {
            if (!passEnabled) { const ok = confirm('Set a passcode to encrypt your data on this device?'); if (ok) { await setPasscode(); updatePassBtn(); } return; }
            const action = prompt('Type one: lock / change / remove'); if (!action) return;
            const a = action.toLowerCase(); if (a.startsWith('lock')) await lockNow();
            else if (a.startsWith('change')) { await changePasscode(); updatePassBtn(); }
            else if (a.startsWith('remove')) { await removePasscode(); updatePassBtn(); }
        });

        exportBtn.addEventListener('click', async () => {
            function download(name, text) { const blob = new Blob([text], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; a.click(); setTimeout(() => URL.revokeObjectURL(url), 1500); }
            if (passEnabled && !passKey) { alert('Unlock first.'); return; }
            if (passEnabled && passKey) { const bundle = await encryptJSON(state, passKey); download('habit-tracker-backup.enc.json', JSON.stringify({ enc: bundle, meta }, null, 2)); }
            else download('habit-tracker-backup.json', JSON.stringify(state, null, 2));
        });

        importInput.addEventListener('change', async (e) => {
            const file = e.target.files?.[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    const obj = JSON.parse(reader.result);
                    if (obj && obj.enc && obj.meta) {
                        const pass = prompt('Enter passcode for this backup:'); if (!pass) return;
                        const key = await deriveAesKey(pass, obj.meta.salt, obj.meta.iterations || 150000);
                        const plain = await decryptJSON(obj.enc, key); state = plain; await save(); renderAll(); alert('Encrypted import successful.');
                    } else if (obj && obj.habits && obj.completions) {
                        state = obj; state.notes = state.notes || { weekly: {}, daily: {} }; state.responsibilities = state.responsibilities || {}; state.respEntries = state.respEntries || {};
                        await save(); renderAll(); alert('Import successful.');
                    } else alert('Invalid file.');
                } catch (err) { alert('Failed to import: ' + err.message); }
            };
            reader.readAsText(file); e.target.value = '';
        });

        /* ================================================================
           Boot
        ================================================================ */
        (async function init() {
            const encStr = localStorage.getItem(LS_ENC);
            const metaStr = localStorage.getItem(LS_META);
            if (encStr && metaStr) {
                passEnabled = true; meta = JSON.parse(metaStr);
                for (let tries = 0; tries < 3; tries++) {
                    const pass = prompt('Enter passcode to unlock:'); if (pass === null) break;
                    try { passKey = await deriveAesKey(pass, meta.salt, meta.iterations); state = await decryptJSON(JSON.parse(encStr), passKey); break; }
                    catch (e) { alert('Incorrect passcode.'); }
                }
                if (!state || !state.habits) state = structuredClone(initialState);
            } else {
                state = loadPlain();
            }
            state.notes = state.notes || { weekly: {}, daily: {} };
            state.responsibilities = state.responsibilities || {};
            state.respEntries = state.respEntries || {};

            updatePassBtn();
            renderAll();
        })();

        function renderAll() {
            renderHeader();
            renderDaily();
            renderWeekly();
            renderResponsibilities();
            updateProgressBits();
        }
    </script>
</body>

</html>