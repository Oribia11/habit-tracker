<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minimal Habit/Task Tracker</title>
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.441.0/font/lucide.css" />
    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        input,
        select,
        textarea,
        button {
            font-size: 16px;
        }

        /* iOS zoom fix */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* --- Micro navigation animations --- */
        .nav-enter {
            animation: slideIn .22s cubic-bezier(.2, .6, .2, 1) both;
        }

        .nav-left {
            --dx: -18px;
        }

        .nav-right {
            --dx: 18px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(var(--dx));
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .pulse {
            animation: pulse .25s ease-out;
        }

        @keyframes pulse {
            from {
                transform: scale(.98);
            }

            to {
                transform: scale(1);
            }
        }
    /* Design tokens */
    :root{
        --bg: #f6f8fa;
        --card: #ffffff;
        --muted: #64748b;
        --accent: #10b981;
        --accent-2: #34d399;
        --danger: #ef4444;
        --surface: #f1f5f9;
        --radius: 12px;
        --gap: 12px;
        --glass: rgba(255,255,255,0.6);
    }
    html, body { height: 100%; margin:0; background: linear-gradient(180deg, #f8fafc 0%, #f6f8fa 100%); }
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color: #0f172a; }

    /* App layout */
    #app { height: 100vh; display: grid; grid-template-rows: auto auto 1fr; gap: var(--gap); padding: 18px; box-sizing: border-box; }

    /* Card base */
    .card {
        background: linear-gradient(180deg, var(--card), #fbfdff);
        border: 1px solid rgba(15,23,42,0.06);
        border-radius: var(--radius);
        box-shadow: 0 6px 18px rgba(15,23,42,0.04);
        transition: transform .12s ease, box-shadow .12s ease;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 28px rgba(15,23,42,0.06); }
    .card-compact { padding: 14px; }
    .card-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .card-title { font-weight:700; color:#0f172a; font-size:14px; }
    .card-sub { font-size:13px; color:var(--muted); }
    .card-actions { display:flex; gap:10px; align-items:center; }

    /* Buttons */
    .btn { border-radius:10px; padding:8px 12px; border:1px solid rgba(2,6,23,0.06); background:#fff; font-size:13px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    .btn.small { padding:6px 10px; font-size:13px; border-radius:8px; }
    .btn.ghost { background:transparent; border-color: transparent; color:var(--muted); }
    .btn.primary { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; border-color: rgba(16,185,129,0.18); box-shadow: 0 6px 16px rgba(16,185,129,0.08); }
    .btn.danger { background: linear-gradient(90deg,#fb7185,#ef4444); color:white; }
    .btn:focus { outline: 3px solid rgba(16,185,129,0.12); }

    /* compact list area */
    .list-fit { overflow:auto; max-height: calc(100vh - 220px); }

    /* smaller notes area */
    textarea#weekNotes { min-height:56px; font-size:13px; }

    /* responsibilities day cell compact styling */
    #respList .h-6 { height:22px; line-height:22px; font-size:11px; }

    /* Segmented day chips */
    .seg { display:inline-flex; align-items:center; justify-content:center; height:26px; min-width:28px; padding:0 6px; border-radius:6px; font-size:11px; margin-right:6px; border:1px solid rgba(15,23,42,0.04); box-shadow: inset 0 -1px 0 rgba(255,255,255,0.2); cursor:pointer; transition: transform .08s ease, box-shadow .08s ease; }
    .seg:last-child { margin-right:0; }
    .seg:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(2,6,23,0.06); }
    .seg--filled { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color: white; border-color: rgba(52,211,153,0.18); }
    .seg--empty { background: var(--surface); color:var(--muted); }

    /* Inputs */
    input[type=number], input[type=text] { border: 1px solid #e6eef2; background: #fbfdff; padding:8px; border-radius:8px; }

    /* thinner scrollbar */
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: rgba(15,23,42,0.08); border-radius: 10px; }

    /* Responsibilities specific */
    .resp-card { background: linear-gradient(180deg,#ffffff,#fbfdff); border: 1px solid rgba(15,23,42,0.04); padding:12px; border-radius:10px; box-shadow: 0 6px 14px rgba(12,18,31,0.03); }
    .resp-title-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .resp-title { display:flex; align-items:center; gap:8px; }
    .resp-meta { font-size:12px; color:var(--muted); }
    .resp-controls { display:flex; align-items:center; gap:10px; }
    /* Make action buttons visually similar to task buttons */
    .resp-link { background: var(--surface); border:none; color:var(--muted); cursor:pointer; font-weight:600; padding:6px 10px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; min-width:68px; height:34px; border:1px solid rgba(15,23,42,0.03); font-size:13px; }
    .resp-link svg { margin-right:8px; }
    .resp-link:hover { background: rgba(2,6,23,0.03); transform: translateY(-2px); }
    .resp-link.danger { color: var(--danger); border-color: rgba(239,68,68,0.06); }

    /* Hide action buttons until hover / keyboard focus */
    .resp-actions { opacity: 0; transform: translateY(4px); transition: opacity .14s ease, transform .12s ease; pointer-events: none; }
    .resp-card:hover .resp-actions, .resp-card:focus-within .resp-actions { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .resp-exp-input { width:70px; padding:8px; border-radius:8px; border:1px solid #e6eef2; }
    .resp-chips { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }

    /* Grid layout for responsibility rows: title | chips | controls */
    /* Use minmax(0, 1fr) so columns can shrink properly and avoid overflow */
    .resp-grid { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) 110px; gap:12px; align-items:center; column-gap:14px; }
    .resp-left { min-width: 0; overflow: hidden; }
    .resp-title { font-weight:700; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; }
    .resp-summary { font-size:13px; color:var(--muted); margin-top:4px; }
    .resp-center { display:flex; justify-content:flex-start; gap:8px; flex-wrap:wrap; min-width:0; overflow:hidden; }
    .resp-right { display:flex; flex-direction:column; align-items:flex-end; gap:8px; flex-shrink:0; }
    .resp-exp-input { width:80px; }

    /* Ensure chips don't stretch into the controls area */
    .resp-chips { max-width: calc(100% - 8px); overflow: hidden; }
    .seg { flex: 0 0 auto; }

    /* Make action buttons more compact so right column stays narrow */
    .resp-link { min-width:40px; padding:6px; }
    .resp-link svg { margin:0; }

    /* Multi-week horizontal progress bar */
    /* Continuous stacked per-day bar */
    .resp-cont-bar { height:12px; border-radius:10px; background:var(--surface); overflow:hidden; display:flex; align-items:center; margin-top:12px; border:1px solid rgba(15,23,42,0.03); }
    .resp-day-seg { height:100%; display:block; transition: width .18s linear; }
    .day-col-0 { background: #60a5fa; } /* Mon */
    .day-col-1 { background: #34d399; } /* Tue */
    .day-col-2 { background: #f59e0b; } /* Wed */
    .day-col-3 { background: #f97316; } /* Thu */
    .day-col-4 { background: #ef4444; } /* Fri */
    .day-col-5 { background: #a78bfa; } /* Sat */
    .day-col-6 { background: #60a5fa; opacity:0.85; } /* Sun */
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <div id="app" class="max-w-6xl mx-auto px-3 py-3">
        <!-- Header: improved layout -->
        <div class="card card-compact" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div>
                <div id="dateHeading" class="card-title"></div>
                <div id="weekMeta" class="card-sub" style="margin-top:4px;"></div>
                <div id="eventBanner" class="card-sub" style="margin-top:4px;"></div>
            </div>
            <div class="card-actions">
                <button id="passBtn" class="btn small ghost">Passcode</button>
                <button id="exportBtn" class="btn small ghost">Export</button>
                <label class="btn small ghost" style="display:inline-flex; align-items:center; gap:6px; cursor:pointer;">
                    Import
                    <input id="importInput" type="file" accept="application/json" class="hidden" />
                </label>
            </div>
        </div>

        <!-- Top Stats: Progress + Trend (compact, aligned) -->
        <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="card card-compact">
                <div class="card-header">
                    <div>
                        <div class="card-title">This week</div>
                        <div id="weekBarLabel" class="card-sub" style="margin-top:6px;">0 / 0 tasks completed this week (0%)</div>
                    </div>
                    <div id="weekPct" class="card-title">0%</div>
                </div>
                <div class="mt-2 h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div id="weekBar" class="h-full" style="width:0%; background:linear-gradient(90deg,var(--accent),#34d399);"></div>
                </div>
            </div>
            <div class="card card-compact">
                <div class="card-header">
                    <div class="card-title">Weekly completion trend</div>
                    <div class="card-sub">Since Q1 start</div>
                </div>
                <div id="trendWrap" class="mt-1 h-28 md:h-32">
                    <canvas id="trendChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Main: Daily & Weekly side-by-side (aligned heights) -->
    <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3">
            <!-- Daily Column -->
    <section id="dailyCol" class="card card-compact flex flex-col">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center gap-2 text-sm">
            <button id="prevDay" class="btn small ghost">◀</button>
            <button id="todayBtn" class="btn small ghost">Today</button>
            <button id="nextDay" class="btn small ghost">▶</button>
                        <span id="dailyDateLabel" class="ml-2 text-slate-600"></span>
                    </div>
        <button id="addDaily" class="btn primary small">+ Daily</button>
                </div>
        <div id="dailyList" class="mt-2 space-y-1 list-fit"></div>
            </section>

            <!-- Weekly Column -->
            <section id="weeklyCol" class="card card-compact flex flex-col">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center gap-2 text-sm">
                        <button id="prevWeek" class="btn small ghost">◀</button>
                        <button id="thisWeekBtn" class="btn small ghost">This week</button>
                        <button id="nextWeek" class="btn small ghost">▶</button>
                        <span id="weeklyRangeLabel" class="ml-2 text-slate-600"></span>
                        <span id="weeklyMetaPill"
                            class="ml-2 text-xs px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200"></span>
                    </div>
                    <button id="addWeekly" class="btn primary small">+ Weekly</button>
                </div>
                <div id="weeklyList" class="mt-2 space-y-1 list-fit"></div>
                <!-- Weekly Notes -->
                <div class="mt-2">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold text-slate-800">Notes for this week</h4>
                        <span id="notesSaved" class="text-[11px] text-slate-500"></span>
                    </div>
                    <textarea id="weekNotes" placeholder="Reflections, wins, blockers…"
                        class="mt-1 w-full min-h-[56px] rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 p-2 text-sm"></textarea>
                </div>
            </section>

            <!-- Responsibilities Column (moved into main grid) -->
            <section id="responsibilitiesCol" class="card card-compact flex flex-col">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-slate-800">Responsibilities (hours)</h3>
                    <div class="flex items-center gap-2">
                        <button id="addRespBtn" onclick="addResponsibility()" class="btn primary small">+ Add</button>
                    </div>
                </div>
                <div id="respList" class="mt-2 space-y-2 list-fit"></div>
                <p class="mt-2 text-[11px] text-slate-500">Click a day cell to enter hours for that responsibility. Expected hours are weekly totals.</p>
            </section>
        </div>

        <!-- Footer -->
        <p class="mt-4 text-[11px] text-slate-500">Local-only, privacy-friendly. Data is saved in your browser on this
            device. No accounts, no servers.</p>
    </div>

    <script>
        /*************************************************
         * Academic calendar (2025–2026) — Quartiles & events
         *************************************************/
        const ACADEMIC = {
            q1: { id: 'Q1', start: '2025-09-01', end: '2025-11-08' },
            q2: { id: 'Q2', start: '2025-11-10', end: '2026-01-31' },
            q3: { id: 'Q3', start: '2026-02-02', end: '2026-04-18' },
            q4: { id: 'Q4', start: '2026-04-20', end: '2026-07-04' },
            important: [
                { date: '2025-09-26', label: 'Momentum (no teaching)' },
                { date: '2025-10-12', label: 'Closing date: registration/withdrawal exams & courses Q1' },
                { date: '2025-11-15', label: 'Opens: registration Q3 & Q4' },
                { start: '2025-12-22', end: '2026-01-02', label: 'Christmas recess (no teaching)' },
                { date: '2026-01-04', label: 'Closing date: registration/withdrawal exams & courses Q2' },
                { start: '2026-02-16', end: '2026-02-20', label: 'Carnival holiday' },
                { date: '2026-03-14', label: "Master's open day (no teaching from 17:30)" },
                { date: '2026-03-22', label: 'MyFuture week + Closing date registration/withdrawal Q3' },
                { date: '2026-04-03', label: 'Good Friday' },
                { date: '2026-04-05', label: 'Easter Sunday' },
                { date: '2026-04-06', label: 'Easter Monday' },
                { date: '2026-04-27', label: "King's Day" },
                { date: '2026-05-04', label: 'Bridge Day' },
                { date: '2026-05-05', label: 'Liberation Day' },
                { start: '2026-05-14', end: '2026-05-15', label: 'Ascension Day + Bridge Day' },
                { date: '2026-05-24', label: 'Whitsun' },
                { date: '2026-05-25', label: 'Whit Monday' },
                { date: '2026-06-07', label: 'Closing date registration/withdrawal exams & courses Q4' },
                { date: '2026-06-15', label: 'Opening registration for Q1 & Q2 (next year)' },
            ]
        };

        /*************************************************
         * Date helpers (local timezone, Monday-based weeks)
         *************************************************/
        const MONTH_ABBR = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
        const WEEKDAY = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        function dFromISO(iso) {
            const [y, m, d] = iso.split('-').map(Number);
            const dt = new Date(y, m - 1, d, 12, 0, 0, 0);
            dt.setHours(12);
            return dt;
        }
        function toISODate(dt) {
            const y = dt.getFullYear();
            const m = String(dt.getMonth() + 1).padStart(2, '0');
            const d = String(dt.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function startOfWeek(dt) {
            const d = new Date(dt);
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1 - day);
            d.setDate(d.getDate() + diff);
            d.setHours(12);
            return d;
        }
        function addDays(dt, n) { const d = new Date(dt); d.setDate(d.getDate() + n); d.setHours(12); return d; }
        function addWeeks(dt, n) { return addDays(dt, n * 7); }
        function weekKey(dt) { // calendar-year storage key (compat)
            const monday = startOfWeek(dt);
            const y = monday.getFullYear();
            const oneJan = new Date(y, 0, 1, 12);
            const days = Math.floor((monday - startOfWeek(oneJan)) / 86400000);
            const wk = Math.floor(days / 7) + 1;
            return `${y}-W${String(wk).padStart(2, '0')}`;
        }
        function formatHeadingDate(dt) {
            const w = WEEKDAY[dt.getDay()];
            const d = String(dt.getDate()).padStart(2, '0');
            const m = MONTH_ABBR[dt.getMonth()];
            const y = dt.getFullYear();
            return `${w} ${d}${m}${y}`;
        }

        /*************************************************
         * Quartile + academic-week calculations
         *************************************************/
        const Q_LIST = [ACADEMIC.q1, ACADEMIC.q2, ACADEMIC.q3, ACADEMIC.q4];
        const Q1_START = dFromISO(ACADEMIC.q1.start); // academic year baseline

        function findQuartile(dt) {
            const iso = toISODate(dt);
            for (const q of Q_LIST) { if (iso >= q.start && iso <= q.end) return q; }
            return null;
        }
        function weekNumberInQuartile(dt) {
            const q = findQuartile(dt);
            if (!q) return { q: null, weekInQ: null };
            const start = startOfWeek(dFromISO(q.start));
            const monday = startOfWeek(dt);
            const diffDays = Math.floor((monday - start) / 86400000);
            const weekInQ = Math.floor(diffDays / 7) + 1;
            return { q, weekInQ };
        }
        function overallWeekNumber(dt) { // 1-based since academic year start
            const start = startOfWeek(Q1_START);
            const monday = startOfWeek(dt);
            const diffDays = Math.floor((monday - start) / 86400000);
            return Math.floor(diffDays / 7) + 1;
        }
        function formatWeekRange(dt) {
            const mon = startOfWeek(dt);
            const sun = addDays(mon, 6);
            const m1 = MONTH_ABBR[mon.getMonth()], m2 = MONTH_ABBR[sun.getMonth()];
            return `${String(mon.getDate()).padStart(2, '0')}${m1}${mon.getFullYear()} – ${String(sun.getDate()).padStart(2, '0')}${m2}${sun.getFullYear()}`;
        }
        function todayEventBanner(dt) {
            const iso = toISODate(dt);
            for (const e of ACADEMIC.important) {
                if (e.date && e.date === iso) return e.label;
                if (e.start && e.end && iso >= e.start && iso <= e.end) return e.label;
            }
            return '';
        }

        /*************************************************
         * Storage model (localStorage) + optional encryption
         *************************************************/
        const LS_KEY = 'habitTrackerV1';            // plaintext
        const LS_ENC = 'habitTrackerV1_enc';       // encrypted {iv, ct}
        const LS_META = 'habitTrackerV1_meta';     // {salt, iterations}

    const initialState = { habits: [], completions: { daily: {}, weekly: {} }, notes: { weekly: {} }, responsibilities: {}, respEntries: {} };

        function loadPlain() {
            try { return JSON.parse(localStorage.getItem(LS_KEY)) || structuredClone(initialState); }
            catch (e) { return structuredClone(initialState); }
        }

        // b64 helpers
        const b2a = (bytes) => btoa(String.fromCharCode(...bytes));
        const a2b = (b64) => new Uint8Array(atob(b64).split('').map(c => c.charCodeAt(0)));

        async function deriveAesKey(pass, saltB64, iterations) {
            const enc = new TextEncoder();
            const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: a2b(saltB64), iterations, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }
        async function encryptJSON(obj, key) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const data = new TextEncoder().encode(JSON.stringify(obj));
            const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data);
            return { iv: b2a(iv), ct: b2a(new Uint8Array(ct)) };
        }
        async function decryptJSON(bundle, key) {
            const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: a2b(bundle.iv) }, key, a2b(bundle.ct));
            return JSON.parse(new TextDecoder().decode(new Uint8Array(pt)));
        }

        // runtime vars
        let state = structuredClone(initialState);
        let passEnabled = false;
        let passKey = null; // CryptoKey
        let meta = null;    // {salt, iterations}

        async function save() {
            // make sure notes object exists (backwards compatible)
            state.notes = state.notes || { weekly: {} };
            if (passEnabled && passKey) {
                const bundle = await encryptJSON(state, passKey);
                localStorage.setItem(LS_ENC, JSON.stringify(bundle));
                localStorage.setItem(LS_META, JSON.stringify(meta));
                localStorage.removeItem(LS_KEY); // no plaintext
            } else {
                localStorage.setItem(LS_KEY, JSON.stringify(state));
            }
        }

        /*************************************************
         * UI Helpers + CRUD
         *************************************************/
        function uid() { return Math.random().toString(36).slice(2, 10); }
        function el(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstElementChild; }

        function addHabit(type) {
            const title = prompt(`New ${type} habit name:`)?.trim();
            if (!title) return;
            state.habits.push({ id: uid(), title, type, createdAt: Date.now(), order: Date.now() });
            save(); renderAll();
        }

        // Responsibilities: each has id, title, expectedHours (weekly)
        function addResponsibility() {
            state.responsibilities = state.responsibilities || {};
            state.respEntries = state.respEntries || {};
            const formId = 'resp-new-form';
            if (document.getElementById(formId)) {
                document.getElementById(formId).querySelector('input')?.focus();
                return;
            }
            const form = el(`
                <div id="${formId}" class="card" style="padding:8px; margin-bottom:8px;">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input id="${formId}-title" placeholder="Responsibility name" class="w-full px-2 py-1 rounded border" />
                        <input id="${formId}-exp" type="number" min="0" step="0.5" value="2" class="w-20 px-2 py-1 rounded border" />
                        <button id="${formId}-save" class="btn primary small">Add</button>
                        <button id="${formId}-cancel" class="btn small ghost">Cancel</button>
                    </div>
                </div>
            `);
            respList.insertBefore(form, respList.firstChild);
            const inputTitle = document.getElementById(`${formId}-title`);
            const inputExp = document.getElementById(`${formId}-exp`);
            const saveBtn = document.getElementById(`${formId}-save`);
            const cancelBtn = document.getElementById(`${formId}-cancel`);
            inputTitle.focus();
            // ensure buttons don't submit any parent form
            saveBtn.setAttribute('type', 'button');
            cancelBtn.setAttribute('type', 'button');

            saveBtn.addEventListener('click', async () => {
                const title = inputTitle.value.trim(); if (!title) { inputTitle.focus(); return; }
                const exp = parseFloat(inputExp.value) || 0;
                const id = uid();
                state.responsibilities[id] = { id, title, expectedHours: exp };
                state.respEntries[id] = {};
                try {
                    await save(); renderAll();
                } catch (err) {
                    console.error('Failed saving responsibility:', err);
                    alert('Failed to save responsibility: ' + (err && err.message ? err.message : String(err)));
                }
            });
            cancelBtn.addEventListener('click', () => { form.remove(); });
        }
        function editResponsibility(id) {
            const r = state.responsibilities[id]; if (!r) return;
            const next = prompt('Rename responsibility:', r.title)?.trim(); if (!next) return;
            const exp = parseFloat(prompt('Expected hours this week (number):', String(r.expectedHours)) || '0') || 0;
            r.title = next; r.expectedHours = exp; save(); renderAll();
        }
        function deleteResponsibility(id) {
            const r = state.responsibilities[id]; if (!r) return;
            if (!confirm(`Delete responsibility “${r.title}”?`)) return;
            delete state.responsibilities[id]; delete state.respEntries[id]; save(); renderAll();
        }
        function editHabit(id) {
            const h = state.habits.find(h => h.id === id); if (!h) return;
            const next = prompt('Rename habit:', h.title)?.trim();
            if (!next) return;
            h.title = next; save(); renderAll();
        }
        function deleteHabit(id) {
            const h = state.habits.find(h => h.id === id); if (!h) return;
            if (!confirm(`Delete “${h.title}”?`)) return;
            state.habits = state.habits.filter(x => x.id !== id);
            for (const day in state.completions.daily) { if (state.completions.daily[day]) delete state.completions.daily[day][id]; }
            for (const wk in state.completions.weekly) { if (state.completions.weekly[wk]) delete state.completions.weekly[wk][id]; }
            save(); renderAll();
        }

        function isPastDay(viewDate) {
            const t = dFromISO(toISODate(new Date()));
            return toISODate(viewDate) < toISODate(t);
        }
        function isPastWeek(viewDate) {
            const t = startOfWeek(new Date());
            return weekKey(viewDate) < weekKey(t);
        }
        function toggleDaily(habitId, dateIso, value) {
            state.completions.daily[dateIso] ||= {};
            state.completions.daily[dateIso][habitId] = !!value;
            save(); updateProgressBits();
        }
        function toggleWeekly(habitId, wkKey, value) {
            state.completions.weekly[wkKey] ||= {};
            state.completions.weekly[wkKey][habitId] = !!value;
            save(); updateProgressBits();
        }

        /*************************************************
         * Rendering
         *************************************************/
        const dateHeading = document.getElementById('dateHeading');
        const weekMeta = document.getElementById('weekMeta');
        const eventBanner = document.getElementById('eventBanner');

        const dailyList = document.getElementById('dailyList');
        const weeklyList = document.getElementById('weeklyList');

        const prevDay = document.getElementById('prevDay');
        const nextDay = document.getElementById('nextDay');
        const todayBtn = document.getElementById('todayBtn');
        const dailyDateLabel = document.getElementById('dailyDateLabel');

        const prevWeek = document.getElementById('prevWeek');
        const nextWeek = document.getElementById('nextWeek');
        const thisWeekBtn = document.getElementById('thisWeekBtn');
        const weeklyRangeLabel = document.getElementById('weeklyRangeLabel');
        const weeklyMetaPill = document.getElementById('weeklyMetaPill');

        const addDailyBtn = document.getElementById('addDaily');
        const addWeeklyBtn = document.getElementById('addWeekly');


        const weekBar = document.getElementById('weekBar');
        const weekBarLabel = document.getElementById('weekBarLabel');
        const weekPct = document.getElementById('weekPct');

        const passBtn = document.getElementById('passBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importInput = document.getElementById('importInput');
    const addRespBtn = document.getElementById('addRespBtn');
    const respList = document.getElementById('respList');

        const weekNotesEl = document.getElementById('weekNotes');
        const notesSaved = document.getElementById('notesSaved');

        let viewDay = dFromISO(toISODate(new Date()));
        let viewWeekDay = dFromISO(toISODate(new Date()));
        let chart;
        let notesDebounce;
    // resp view week pointer uses viewWeekDay

        function renderHeader() {
            const dt = dFromISO(toISODate(new Date()));
            const dateText = formatHeadingDate(dt);
            const { q, weekInQ } = weekNumberInQuartile(dt);
            const overall = Math.max(1, overallWeekNumber(dt));
            const qId = q ? q.id : 'N/A';
            dateHeading.textContent = dateText;
            weekMeta.textContent = `Week #${overall}; week #${weekInQ ?? '—'}; ${qId}`;

            const banner = todayEventBanner(dt);
            eventBanner.textContent = banner ? `Today: ${banner}` : '';
        }

        function renderDaily() {
            dailyDateLabel.textContent = formatHeadingDate(viewDay);
            const readOnly = isPastDay(viewDay);
            const iso = toISODate(viewDay);

            const habits = state.habits.filter(h => h.type === 'daily').sort((a, b) => a.order - b.order);
            const done = state.completions.daily[iso] || {};

            dailyList.innerHTML = '';
            if (habits.length === 0) {
                dailyList.appendChild(el(`<div class="text-sm text-slate-500">No daily habits yet.</div>`));
            }

            for (const h of habits) {
                const row = el(`
        <div class="group flex items-center justify-between bg-white border border-slate-200 rounded-xl px-3 py-2">
          <label class="flex items-center gap-3 text-sm">
            <input type="checkbox" class="h-5 w-5 rounded border-slate-300" ${done[h.id] ? 'checked' : ''} ${readOnly ? 'disabled' : ''}>
            <span>${h.title}</span>
          </label>
          <div class="invisible group-hover:visible flex items-center gap-1">
            <button class="px-2 py-1 text-xs rounded-lg border border-slate-300 bg-white hover:bg-slate-100" data-edit>Edit</button>
            <button class="px-2 py-1 text-xs rounded-lg border border-rose-300 bg-rose-50 text-rose-900 hover:bg-rose-100" data-del>Delete</button>
          </div>
        </div>`);
                const cb = row.querySelector('input[type=checkbox]');
                cb.addEventListener('change', (e) => toggleDaily(h.id, iso, e.target.checked));
                row.querySelector('[data-edit]').addEventListener('click', () => editHabit(h.id));
                row.querySelector('[data-del]').addEventListener('click', () => deleteHabit(h.id));
                dailyList.appendChild(row);
            }
        }

        function renderWeekly() {
            weeklyRangeLabel.textContent = formatWeekRange(viewWeekDay);
            const readOnly = isPastWeek(viewWeekDay);
            const wk = weekKey(viewWeekDay);

            const habits = state.habits.filter(h => h.type === 'weekly').sort((a, b) => a.order - b.order);
            const done = state.completions.weekly[wk] || {};

            weeklyList.innerHTML = '';
            if (habits.length === 0) {
                weeklyList.appendChild(el(`<div class="text-sm text-slate-500">No weekly habits yet.</div>`));
            }

            for (const h of habits) {
                const row = el(`
        <div class="group flex items-center justify-between bg-white border border-slate-200 rounded-xl px-3 py-2">
          <label class="flex items-center gap-3 text-sm">
            <input type="checkbox" class="h-5 w-5 rounded border-slate-300" ${done[h.id] ? 'checked' : ''} ${readOnly ? 'disabled' : ''}>
            <span>${h.title}</span>
          </label>
          <div class="invisible group-hover:visible flex items-center gap-1">
            <button class="px-2 py-1 text-xs rounded-lg border border-slate-300 bg-white hover:bg-slate-100" data-edit>Edit</button>
            <button class="px-2 py-1 text-xs rounded-lg border border-rose-300 bg-rose-50 text-rose-900 hover:bg-rose-100" data-del>Delete</button>
          </div>
        </div>`);
                const cb = row.querySelector('input[type=checkbox]');
                cb.addEventListener('change', (e) => toggleWeekly(h.id, wk, e.target.checked));
                row.querySelector('[data-edit]').addEventListener('click', () => editHabit(h.id));
                row.querySelector('[data-del]').addEventListener('click', () => deleteHabit(h.id));
                weeklyList.appendChild(row);
            }

            // Weekly notes + pill
            weekNotesEl.value = (state.notes && state.notes.weekly && state.notes.weekly[wk]) || '';
            notesSaved.textContent = '';
            weekNotesEl.oninput = (e) => {
                clearTimeout(notesDebounce);
                state.notes = state.notes || { weekly: {} };
                state.notes.weekly[wk] = e.target.value;
                notesSaved.textContent = 'Saving…';
                notesDebounce = setTimeout(async () => { await save(); notesSaved.textContent = 'Saved'; setTimeout(() => { if (notesSaved.textContent === 'Saved') notesSaved.textContent = ''; }, 1000); }, 300);
            };

            const { q, weekInQ } = weekNumberInQuartile(viewWeekDay) || {};
            const overall = overallWeekNumber(viewWeekDay);
            weeklyMetaPill.textContent = `W${overall}${q ? ` • ${q.id} w${weekInQ}` : ''}`;
        }

                // Responsibilities rendering
                function renderResponsibilities() {
                        respList.innerHTML = '';
                        const respKeys = Object.keys(state.responsibilities || {});
                        if (respKeys.length === 0) {
                                respList.appendChild(el(`<div class="text-sm text-slate-500">No responsibilities yet.</div>`));
                                return;
                        }
                        const mon = startOfWeek(viewWeekDay);
                        for (const id of respKeys) {
                                const r = state.responsibilities[id];
                                const entries = state.respEntries[id] || {};
                                // compute weekly totals and per-day values
                                const days = [];
                                let total = 0;
                                for (let i = 0; i < 7; i++) {
                                        const iso = toISODate(addDays(mon, i));
                                        const v = parseFloat(entries[iso]) || 0; days.push({ iso, v }); total += v;
                                }

                                // removed per-day chips/buttons — using continuous bar only

                                const row = el(`
                                    <div class="resp-card">
                                        <div class="resp-grid">
                                            <div class="resp-left">
                                                <div class="resp-title">${r.title}</div>
                                                <div class="resp-summary">${total}h / ${r.expectedHours}h</div>
                                            </div>
                                            <div class="resp-center"></div>
                                            <div class="resp-right">
                                                <input type="number" min="0" step="0.5" value="${r.expectedHours}" class="resp-exp-input" data-exp>
                                                <div class="resp-actions" style="display:flex; gap:8px;">
                                                    <button class="resp-link" data-edit title="Rename">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 21h3.75L17.81 9.94l-3.75-3.75L3 17.25V21z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                                    </button>
                                                    <button class="resp-link danger" data-del title="Delete">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 11v6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 11v6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="resp-cont-bar" aria-hidden="true"></div>
                                    </div>
                                `);

                                // per-day chips removed; hover summary disabled as requested

                                row.querySelector('[data-edit]').addEventListener('click', () => editResponsibility(id));
                                row.querySelector('[data-del]').addEventListener('click', () => deleteResponsibility(id));
                                row.querySelector('[data-exp]').addEventListener('change', (e) => { r.expectedHours = parseFloat(e.target.value) || 0; save(); renderAll(); });

                                // render continuous per-day stacked bar (day colors show the spread)
                                const contBar = row.querySelector('.resp-cont-bar');
                                if (contBar) {
                                    contBar.innerHTML = '';
                                    const expected = Math.max(1, r.expectedHours || 0);
                                    for (let i = 0; i < days.length; i++) {
                                        const d = days[i];
                                        const pct = Math.max(0, Math.min(100, Math.round((d.v / expected) * 100)));
                                        const widthStyle = d.v > 0 && pct < 1 ? 'width:1px' : `width:${pct}%`;
                                        const weekday = WEEKDAY[addDays(mon, i).getDay()].slice(0,3);
                                        const seg = el(`<div class="resp-day-seg day-col-${i}" title="${weekday}: ${d.v}h" style="${widthStyle}"></div>`);
                                        // allow clicking the segment to edit hours for that day
                                        seg.addEventListener('click', () => {
                                            const iso = d.iso;
                                            const cur = parseFloat(state.respEntries[id]?.[iso]) || 0;
                                            const v = parseFloat(prompt(`Hours logged on ${weekday} for ${r.title}:`, String(cur)) || '0') || 0;
                                            state.respEntries[id] = state.respEntries[id] || {};
                                            if (v <= 0) delete state.respEntries[id][iso]; else state.respEntries[id][iso] = v;
                                            save(); renderAll();
                                        });
                                        contBar.appendChild(seg);
                                    }
                                }

                                respList.appendChild(row);
                        }
                }

        // Progress
        function computeWeekProgress(monday) {
            const allDaily = state.habits.filter(h => h.type === 'daily');
            const allWeekly = state.habits.filter(h => h.type === 'weekly');
            const required = allDaily.length * 7 + allWeekly.length;
            if (required === 0) return { pct: 0, num: 0, den: 0 };

            let num = 0;
            for (let i = 0; i < 7; i++) {
                const iso = toISODate(addDays(monday, i));
                const set = state.completions.daily[iso] || {};
                for (const h of allDaily) { if (set[h.id]) num++; }
            }
            const wk = weekKey(monday);
            const setW = state.completions.weekly[wk] || {};
            for (const h of allWeekly) { if (setW[h.id]) num++; }

            const pct = Math.round((num / required) * 100);
            return { pct, num, den: required };
        }

        function updateProgressBits() {
            const monday = startOfWeek(new Date());
            const { pct, num, den } = computeWeekProgress(monday);
            weekBar.style.width = pct + '%';
            weekBarLabel.textContent = `${num} / ${den} tasks completed this week (${pct}%)`;
            weekPct.textContent = pct + '%';
            drawTrend();
        }

        function drawTrend() {
            const ctx = document.getElementById('trendChart');
            const startMon = startOfWeek(Q1_START);
            const todayMon = startOfWeek(new Date());
            const currentWeek = Math.max(1, overallWeekNumber(todayMon));
            const windowSize = Math.min(8, currentWeek);

            const labels = [];
            const data = [];
            for (let i = currentWeek - windowSize + 1; i <= currentWeek; i++) {
                const wkMon = addWeeks(startMon, i - 1);
                const { pct } = computeWeekProgress(wkMon);
                labels.push('W' + i);
                data.push(pct);
            }

            if (chart) { chart.destroy(); }
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Completion %', data, tension: 0.35, pointRadius: 2 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 100, ticks: { stepSize: 25 } }, x: { ticks: { maxRotation: 0, autoSkip: false } } },
                    plugins: { legend: { display: false }, tooltip: { intersect: false } },
                    elements: { line: { borderWidth: 2 }, point: { hitRadius: 6 } }
                }
            });
        }

        function renderAll() {
            renderHeader();
            renderDaily();
            renderWeekly();
            renderResponsibilities();
            updateProgressBits();
        }

        /*************************************************
         * Passcode actions
         *************************************************/
        async function setPasscode() {
            if (passEnabled) { alert('Passcode already set.'); return; }
            const p1 = prompt('Set a passcode:'); if (!p1) return;
            const p2 = prompt('Repeat passcode:'); if (p1 !== p2) { alert('Passcodes do not match.'); return; }
            const salt = crypto.getRandomValues(new Uint8Array(16));
            meta = { salt: b2a(salt), iterations: 150000 };
            passKey = await deriveAesKey(p1, meta.salt, meta.iterations);
            passEnabled = true;
            await save();
            alert('Passcode set. Your data is now encrypted on this device.');
        }
        async function lockNow() {
            if (!passEnabled) { const ok = confirm('No passcode set. Set one now?'); if (ok) await setPasscode(); return; }
            await save();
            location.reload();
        }
        async function changePasscode() {
            if (!passEnabled) { alert('No passcode set.'); return; }
            const cur = prompt('Enter current passcode:'); if (cur === null) return;
            try {
                const testKey = await deriveAesKey(cur, meta.salt, meta.iterations);
                const enc = localStorage.getItem(LS_ENC);
                if (enc) { await decryptJSON(JSON.parse(enc), testKey); }
            } catch (e) { alert('Incorrect current passcode.'); return; }
            const p1 = prompt('New passcode:'); if (!p1) return;
            const p2 = prompt('Repeat new passcode:'); if (p1 !== p2) { alert('Passcodes do not match.'); return; }
            const salt = crypto.getRandomValues(new Uint8Array(16));
            meta = { salt: b2a(salt), iterations: 150000 };
            passKey = await deriveAesKey(p1, meta.salt, meta.iterations);
            await save();
            alert('Passcode changed.');
        }
        async function removePasscode() {
            if (!passEnabled) { alert('No passcode set.'); return; }
            if (!confirm('Remove passcode and store data in plaintext on this device?')) return;
            passEnabled = false; passKey = null; meta = null;
            localStorage.removeItem(LS_META);
            localStorage.removeItem(LS_ENC);
            await save();
            alert('Passcode removed.');
        }

        function updatePassBtn() {
            passBtn.textContent = passEnabled ? 'Passcode (On)' : 'Passcode (Off)';
        }

        /*************************************************
         * Visible nav transitions
         *************************************************/
        function animateNav(kind, dir) {
            const els = [];
            if (kind === 'daily') els.push(dailyList, dailyDateLabel);
            if (kind === 'weekly') els.push(weeklyList, weeklyRangeLabel, weeklyMetaPill);
            for (const el of els) {
                if (!el) continue;
                el.classList.remove('nav-enter', 'nav-left', 'nav-right', 'pulse');
                // Force reflow so animation restarts
                void el.offsetWidth;
                el.classList.add('nav-enter', dir === 'prev' ? 'nav-left' : 'nav-right');
            }
        }

        /*************************************************
         * Event wiring
         *************************************************/
        prevDay.addEventListener('click', () => { viewDay = addDays(viewDay, -1); renderDaily(); animateNav('daily', 'prev'); });
        nextDay.addEventListener('click', () => { viewDay = addDays(viewDay, +1); renderDaily(); animateNav('daily', 'next'); });
        todayBtn.addEventListener('click', () => { viewDay = dFromISO(toISODate(new Date())); renderDaily(); dailyDateLabel.classList.add('pulse'); setTimeout(() => dailyDateLabel.classList.remove('pulse'), 260); });

        prevWeek.addEventListener('click', () => { viewWeekDay = addWeeks(viewWeekDay, -1); renderWeekly(); animateNav('weekly', 'prev'); });
        nextWeek.addEventListener('click', () => { viewWeekDay = addWeeks(viewWeekDay, +1); renderWeekly(); animateNav('weekly', 'next'); });
        thisWeekBtn.addEventListener('click', () => { viewWeekDay = dFromISO(toISODate(new Date())); renderWeekly(); weeklyRangeLabel.classList.add('pulse'); setTimeout(() => weeklyRangeLabel.classList.remove('pulse'), 260); });

        addDailyBtn.addEventListener('click', () => addHabit('daily'));
        addWeeklyBtn.addEventListener('click', () => addHabit('weekly'));
    if (addRespBtn) addRespBtn.addEventListener('click', () => addResponsibility());

        passBtn.addEventListener('click', async () => {
            if (!passEnabled) {
                const ok = confirm('Set a passcode to encrypt your data on this device?');
                if (ok) { await setPasscode(); updatePassBtn(); }
                return;
            }
            const action = prompt('Type one: lock / change / remove');
            if (!action) return;
            const a = action.toLowerCase();
            if (a.startsWith('lock')) { await lockNow(); }
            else if (a.startsWith('change')) { await changePasscode(); updatePassBtn(); }
            else if (a.startsWith('remove')) { await removePasscode(); updatePassBtn(); }
        });

        exportBtn.addEventListener('click', async () => {
            function download(name, text) {
                const blob = new Blob([text], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = name; a.click();
                setTimeout(() => URL.revokeObjectURL(url), 2000);
            }
            if (passEnabled && !passKey) {
                alert('Unlock with your passcode first, then export.');
                return;
            }
            if (passEnabled && passKey) {
                const bundle = await encryptJSON(state, passKey);
                download('habit-tracker-backup.enc.json', JSON.stringify({ enc: bundle, meta }, null, 2));
            } else {
                download('habit-tracker-backup.json', JSON.stringify(state, null, 2));
            }
        });

        importInput.addEventListener('change', async (e) => {
            const file = e.target.files?.[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    const obj = JSON.parse(reader.result);
                    if (obj && obj.enc && obj.meta) {
                        const pass = prompt('Enter passcode for this backup:'); if (!pass) return;
                        const key = await deriveAesKey(pass, obj.meta.salt, obj.meta.iterations || 150000);
                        const plain = await decryptJSON(obj.enc, key);
                        state = plain; await save(); renderAll(); alert('Encrypted import successful.');
                    } else if (obj && obj.habits && obj.completions) {
                        state = obj; state.notes = state.notes || { weekly: {} }; await save(); renderAll(); alert('Import successful.');
                    } else {
                        alert('Invalid file format.');
                    }
                } catch (err) { alert('Failed to import: ' + err.message); }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        /*************************************************
         * Boot
         *************************************************/
        (async function init() {
            // detect encryption
            const encStr = localStorage.getItem(LS_ENC);
            const metaStr = localStorage.getItem(LS_META);
            if (encStr && metaStr) {
                passEnabled = true; meta = JSON.parse(metaStr);
                for (let tries = 0; tries < 3; tries++) {
                    const pass = prompt('Enter passcode to unlock:');
                    if (pass === null) break;
                    try {
                        passKey = await deriveAesKey(pass, meta.salt, meta.iterations);
                        state = await decryptJSON(JSON.parse(encStr), passKey);
                        break;
                    } catch (e) { alert('Incorrect passcode.'); }
                }
                if (!state || !state.habits) {
                    // Keep app usable but with empty data (user can try again later)
                    state = structuredClone(initialState);
                }
            } else {
                state = loadPlain();
            }

            // Back-compat for older saves (no notes field)
            state.notes = state.notes || { weekly: {} };
            state.responsibilities = state.responsibilities || {};
            state.respEntries = state.respEntries || {};

            updatePassBtn();
            renderAll();

            console.log('Note: 07 Sept 2025 is a Sunday. Monday is 08 Sept 2025.');
        })();
    </script>
</body>

</html>